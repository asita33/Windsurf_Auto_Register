<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windsurf è‡ªåŠ¨æ³¨å†Œ - ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* ä¸»è‰²è°ƒ - ç°ä»£ç´«ç½—å…° */
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --primary-bg: #f5f3ff;
            
            /* åŠŸèƒ½è‰² */
            --success: #10b981;
            --success-light: #d1fae5;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --info: #3b82f6;
            --info-light: #dbeafe;
            
            /* ä¸­æ€§è‰² */
            --bg-main: #fafbfc;
            --bg-light: #ffffff;
            --bg-card: #ffffff;
            --bg-dark: #0f172a;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* é¡¶éƒ¨å¯¼èˆª - ç°ä»£æ‰å¹³è®¾è®¡ */
        .navbar {
            background: var(--bg-light);
            padding: 24px 32px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .navbar-brand-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .navbar-brand h1 {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .navbar-stats {
            display: flex;
            gap: 32px;
        }
        
        .navbar-stat {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: var(--bg-main);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }
        
        .navbar-stat-icon {
            font-size: 24px;
        }
        
        .navbar-stat-info {
            display: flex;
            flex-direction: column;
        }
        
        .navbar-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        
        .navbar-stat-label {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* æ ‡ç­¾é¡µ - ç°ä»£Pillè®¾è®¡ */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            background: var(--bg-light);
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light);
        }
        
        .tab {
            flex: 1;
            padding: 14px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }
        
        .tab:hover {
            background: var(--primary-bg);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .content-card {
            background: var(--bg-light);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light);
        }
        
        /* è´¦å·åˆ—è¡¨ - å“åº”å¼ç½‘æ ¼ */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .accounts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .account-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .account-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .account-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(139, 92, 246, 0.15);
        }
        
        .account-email {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .account-password {
            font-family: 'Courier New', monospace;
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .account-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .account-time {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .account-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        /* æŒ‰é’®ç³»ç»Ÿ - ç°ä»£æ‰å¹³è®¾è®¡ */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-copy {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border);
        }
        
        .btn-copy:hover {
            background: var(--bg-main);
            border-color: var(--primary-light);
            color: var(--primary);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-lg {
            padding: 12px 24px;
            font-size: 15px;
        }
        
        /* åŠ¨æ€ç ç®¡ç† */
        .activation-section {
            margin-top: 24px;
        }
        
        .activation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .activation-header h2 {
            font-size: 20px;
            color: var(--text-dark);
        }
        
        .code-generator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 32px;
            border-radius: 12px;
            color: white;
            margin-bottom: 24px;
        }
        
        .code-generator h3 {
            font-size: 18px;
            margin-bottom: 16px;
        }
        
        .code-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .code-input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .code-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .code-input-group input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .codes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .code-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .code-card.used {
            opacity: 0.6;
            background: var(--bg-light);
        }
        
        .code-value {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .code-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .code-status.available {
            background: #d1fae5;
            color: #065f46;
        }
        
        .code-status.used {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* æ‰“èµåŒºåŸŸ */
        .donation-section {
            text-align: center;
            padding: 40px;
        }
        
        .donation-card {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .donation-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 16px;
        }
        
        .donation-subtitle {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 32px;
        }
        
        .qr-code-container {
            background: var(--bg-light);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .qr-code-placeholder {
            width: 280px;
            height: 280px;
            margin: 0 auto;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 14px;
        }
        
        .donation-note {
            font-size: 14px;
            color: var(--danger);
            font-weight: 600;
            background: #fef2f2;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--danger);
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .empty-state-title {
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 16px;
            }
            
            .accounts-grid {
                grid-template-columns: 1fr;
            }
            
            .codes-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="navbar">
            <div class="navbar-brand">
                <div class="navbar-brand-icon">ğŸš€</div>
                <div>
                    <h1>Windsurf è‡ªåŠ¨æ³¨å†Œ</h1>
                    <p style="font-size: 13px; color: var(--text-light); margin-top: 2px;">ç®¡ç†åå° v2.0</p>
                </div>
            </div>
            <div class="navbar-stats">
                <div class="navbar-stat">
                    <div class="navbar-stat-icon">ğŸ‘¤</div>
                    <div class="navbar-stat-info">
                        <div class="navbar-stat-value" id="totalAccounts">0</div>
                        <div class="navbar-stat-label">æ€»è´¦å·</div>
                    </div>
                </div>
                <div class="navbar-stat">
                    <div class="navbar-stat-icon">ğŸ”‘</div>
                    <div class="navbar-stat-info">
                        <div class="navbar-stat-value" id="totalCodes">0</div>
                        <div class="navbar-stat-label">åŠ¨æ€ç </div>
                    </div>
                </div>
                <div class="navbar-stat">
                    <div class="navbar-stat-icon">ğŸ“Š</div>
                    <div class="navbar-stat-info">
                        <div class="navbar-stat-value" id="todayAccounts">0</div>
                        <div class="navbar-stat-label">ä»Šæ—¥æ³¨å†Œ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">
                <span>ğŸ“Š</span> Dashboard
            </button>
            <button class="tab" onclick="switchTab('accounts')">
                <span>ğŸ‘¤</span> è´¦å·ç®¡ç†
            </button>
            <button class="tab" onclick="switchTab('emails')">
                <span>ğŸ“¬</span> é‚®ç®±ç®¡ç†
            </button>
            <button class="tab" onclick="switchTab('activation')">
                <span>ğŸ”‘</span> åŠ¨æ€ç 
            </button>
            <button class="tab" onclick="switchTab('ipmanage')">
                <span>ğŸŒ</span> IPç®¡ç†
            </button>
            <button class="tab" onclick="switchTab('donation')">
                <span>ğŸ’</span> æ”¯æŒ
            </button>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="content-card">
                <h2 style="margin-bottom: 24px; color: var(--text-dark);">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
                
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 24px; border-radius: 16px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">æ€»æ³¨å†Œè´¦å·</div>
                        <div style="font-size: 36px; font-weight: 700;" id="dashTotalAccounts">0</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">â†‘ æœ¬å‘¨æ–°å¢ <span id="dashWeeklyAccounts">0</span></div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; padding: 24px; border-radius: 16px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">å¯ç”¨åŠ¨æ€ç </div>
                        <div style="font-size: 36px; font-weight: 700;" id="dashAvailableCodes">0</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">å·²ä½¿ç”¨ <span id="dashUsedCodes">0</span></div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%); color: white; padding: 24px; border-radius: 16px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ä¸´æ—¶é‚®ç®±</div>
                        <div style="font-size: 36px; font-weight: 700;" id="dashTotalEmails">0</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">æ´»è·ƒé‚®ç®±æ•°é‡</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); color: white; padding: 24px; border-radius: 16px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ä»Šæ—¥ä½¿ç”¨IP</div>
                        <div style="font-size: 36px; font-weight: 700;" id="dashActiveIPs">0</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">æ€»IPè®°å½•</div>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div style="background: white; padding: 24px; border-radius: 16px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 16px; color: var(--text-dark);">âš¡ å¿«é€Ÿæ“ä½œ</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="switchTab('accounts')">
                            ğŸ‘¤ ç®¡ç†è´¦å·
                        </button>
                        <button class="btn btn-success" onclick="switchTab('activation'); generateCodes();">
                            ğŸ”‘ ç”ŸæˆåŠ¨æ€ç 
                        </button>
                        <button class="btn" style="background: var(--info); color: white;" onclick="switchTab('emails')">
                            ğŸ“¬ æŸ¥çœ‹é‚®ç®±
                        </button>
                        <button class="btn" style="background: var(--warning); color: white;" onclick="switchTab('ipmanage')">
                            ğŸŒ IPç®¡ç†
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è´¦å·ç®¡ç† -->
        <div id="accounts-tab" class="tab-content">
            <div class="content-card">
                <div class="code-generator">
                    <h3>æ‰‹åŠ¨æ·»åŠ è´¦å·</h3>
                    <div class="code-input-group">
                        <input type="text" id="emailUsername" placeholder="ç”¨æˆ·å" style="flex: 1.2;">
                        <span style="padding: 10px; color: var(--text-dark);">@nimail.cn</span>
                        <input type="text" id="manualPassword" placeholder="å¯†ç ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰" style="flex: 1.2;">
                        <button class="btn" style="background: var(--bg-light); color: var(--text-dark);" onclick="generateRandomUsername()">
                            ğŸ² éšæœº
                        </button>
                        <button class="btn" style="background: white; color: #667eea;" onclick="addAccountManually()">
                            â• æ·»åŠ 
                        </button>
                    </div>
                </div>
                
                <div class="activation-section">
                    <div class="activation-header">
                        <h2>æ³¨å†Œè´¦å·åˆ—è¡¨</h2>
                        <button class="btn btn-primary" onclick="refreshAccounts()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div id="accountsList" class="accounts-grid"></div>
                </div>
            </div>
        </div>
        
        <!-- é‚®ç®±éªŒè¯ç  -->
        <div id="emails-tab" class="tab-content">
            <div class="content-card">
                <div class="activation-header">
                    <h2>ä¸´æ—¶é‚®ç®±åˆ—è¡¨</h2>
                    <button class="btn btn-primary" onclick="refreshEmails()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="emailsList" class="accounts-grid"></div>
            </div>
        </div>
        
        <!-- åŠ¨æ€ç ç®¡ç† -->
        <div id="activation-tab" class="tab-content">
            <div class="content-card">
                <div class="code-generator">
                    <h3>ğŸ”‘ ç”ŸæˆåŠ¨æ€ç </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 13px; color: white; font-weight: 600; margin-bottom: 6px;">ç”Ÿæˆæ•°é‡</label>
                            <input type="number" id="codeCount" placeholder="é»˜è®¤10ä¸ª" value="10" 
                                style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9);">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: white; font-weight: 600; margin-bottom: 6px;">ç é•¿åº¦</label>
                            <input type="number" id="codeLength" placeholder="é»˜è®¤16ä½" value="16"
                                style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9);">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: white; font-weight: 600; margin-bottom: 6px;">æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
                            <input type="number" id="codeExpireDays" placeholder="é»˜è®¤30å¤©" value="30"
                                style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9);">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: white; font-weight: 600; margin-bottom: 6px;">å¯ä½¿ç”¨æ¬¡æ•°</label>
                            <input type="number" id="codeMaxUses" placeholder="é»˜è®¤1æ¬¡" value="1"
                                style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9);">
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="btn btn-primary btn-lg" onclick="generateCodes()">
                            âœ¨ æ‰¹é‡ç”ŸæˆåŠ¨æ€ç 
                        </button>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.9); margin: 0;">
                            ğŸ’¡ æç¤ºï¼šå¯ä½¿ç”¨æ¬¡æ•°ä¸º0è¡¨ç¤ºæ— é™æ¬¡ä½¿ç”¨
                        </p>
                    </div>
                </div>
                
                <div class="activation-section">
                    <div class="activation-header">
                        <h2>å·²ç”Ÿæˆçš„åŠ¨æ€ç </h2>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span id="availableCodesCount" style="color: var(--text-light);"></span>
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="clearAllCodes()">
                                ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰
                            </button>
                            <button class="btn btn-sm" style="background: var(--warning); color: white;" onclick="clearExpiredCodes()">
                                ğŸ—‘ï¸ æ¸…ç†è¿‡æœŸ
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="refreshCodes()">ğŸ”„ åˆ·æ–°</button>
                        </div>
                    </div>
                    <div id="codesList" class="codes-list"></div>
                </div>
            </div>
        </div>
        
        <!-- IPç®¡ç† -->
        <div id="ipmanage-tab" class="tab-content">
            <div class="content-card">
                <!-- é»‘ç™½åå•ç®¡ç† -->
                <div style="margin-bottom: 32px;">
                    <h3>ğŸ›¡ï¸ IPé»‘ç™½åå•</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px;">
                        <!-- ç™½åå• -->
                        <div style="background: var(--success-light); padding: 20px; border-radius: 12px; border: 1px solid var(--success);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: var(--success);">âœ… ç™½åå•ï¼ˆå§‹ç»ˆå…è®¸ï¼‰</h4>
                                <span id="whitelistCount" style="font-size: 12px; color: var(--success);">0ä¸ª</span>
                            </div>
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <input type="text" id="whitelistIP" placeholder="è¾“å…¥IPåœ°å€ï¼Œå¦‚ï¼š192.168.1.1" 
                                    style="flex: 1; padding: 8px 12px; border: 1px solid var(--success); border-radius: 8px; background: white;">
                                <button class="btn btn-success btn-sm" onclick="addToWhitelist()">â• æ·»åŠ </button>
                            </div>
                            <div id="whitelistIPs" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        
                        <!-- é»‘åå• -->
                        <div style="background: var(--danger-light); padding: 20px; border-radius: 12px; border: 1px solid var(--danger);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: var(--danger);">âŒ é»‘åå•ï¼ˆæ°¸ä¹…ç¦æ­¢ï¼‰</h4>
                                <span id="blacklistCount" style="font-size: 12px; color: var(--danger);">0ä¸ª</span>
                            </div>
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <input type="text" id="blacklistIP" placeholder="è¾“å…¥IPåœ°å€ï¼Œå¦‚ï¼š192.168.1.1" 
                                    style="flex: 1; padding: 8px 12px; border: 1px solid var(--danger); border-radius: 8px; background: white;">
                                <button class="btn btn-danger btn-sm" onclick="addToBlacklist()">â• æ·»åŠ </button>
                            </div>
                            <div id="blacklistIPs" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <p style="font-size: 13px; color: var(--text-light); margin: 0;">
                        ğŸ’¡ ç™½åå•IPæ— éœ€æ¿€æ´»ç å³å¯ä½¿ç”¨ï¼›é»‘åå•IPå°†è¢«ç¦æ­¢è®¿é—®
                    </p>
                </div>
                
                <!-- IPä½¿ç”¨è®°å½• -->
                <div class="activation-header" style="margin-top: 32px;">
                    <h2>ğŸ“Š IPä½¿ç”¨è®°å½•</h2>
                    <button class="btn btn-primary" onclick="refreshIPList()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="ipList" class="accounts-grid"></div>
            </div>
        </div>
        
        <!-- æ”¯æŒä½œè€… -->
        <div id="donation-tab" class="tab-content">
            <div class="content-card">
                <div class="donation-section">
                    <div class="donation-card">
                        <div class="donation-title">ğŸ’ æ”¯æŒä½œè€…</div>
                        <div class="donation-subtitle">åˆ›ä½œä¸æ˜“ï¼Œéšå¿ƒæ‰“èµ</div>
                        
                        <div class="qr-code-container">
                            <div class="qr-code-placeholder" id="qrCodeContainer">
                                ä¸Šä¼ ä½ çš„æ”¶æ¬¾äºŒç»´ç 
                            </div>
                        </div>
                        
                        <div class="donation-note">
                            âš ï¸ æ‰“èµåè¯·ç•™è¨€è·å–åŠ¨æ€ç 
                        </div>
                        
                        <div style="margin-top: 24px;">
                            <input type="file" id="qrCodeUpload" accept="image/*" style="display: none;" onchange="uploadQRCode(event)">
                            <button class="btn btn-primary" onclick="document.getElementById('qrCodeUpload').click()">
                                ğŸ“¸ ä¸Šä¼ æ”¶æ¬¾ç 
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é‚®ä»¶æŸ¥çœ‹å¼¹çª— -->
    <div id="emailModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        ">
            <!-- å¼¹çª—æ ‡é¢˜æ  -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div>
                    <h2 id="modalEmailTitle" style="color: white; margin: 0; font-size: 18px;">ğŸ“¬ æ”¶ä»¶ç®±</h2>
                    <p id="modalEmailSubtitle" style="color: rgba(255,255,255,0.8); margin: 4px 0 0 0; font-size: 13px;">åŠ è½½ä¸­...</p>
                </div>
                <button onclick="closeEmailModal()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    width: 32px;
                    height: 32px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">Ã—</button>
            </div>
            
            <!-- é‚®ä»¶åˆ—è¡¨ -->
            <div id="modalEmailList" style="
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            ">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <script>
        // APIé…ç½®
        const API_KEY = 'windsurf-auto-register-2024-secure-key';
        
        // è¾…åŠ©å‡½æ•°ï¼šå¸¦APIå¯†é’¥çš„fetch
        async function apiFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'X-API-Key': API_KEY,
                ...options.headers
            };
            
            return fetch(url, {
                ...options,
                headers
            });
        }
        
        // å…¨å±€çŠ¶æ€
        let accounts = [];
        let activationCodes = [];
        
        // åˆ†é¡µé…ç½®
        const ITEMS_PER_PAGE = 10;
        let currentAccountPage = 1;
        let currentCodePage = 1;
        let filteredAccounts = [];
        let filteredCodes = [];
        let selectedAccounts = new Set();
        let selectedCodes = new Set();
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'accounts') refreshAccounts();
            if (tabName === 'emails') refreshEmails();
            if (tabName === 'activation') refreshCodes();
            if (tabName === 'ipmanage') {
                loadIPLists();
                refreshIPList();
            }
            if (tabName === 'donation') loadQRCode();
        }
        
        // æ›´æ–°Dashboardæ•°æ®
        async function updateDashboard() {
            try {
                // è·å–è´¦å·ç»Ÿè®¡
                const accountsRes = await apiFetch('/api/accounts');
                const accountsData = await accountsRes.json();
                document.getElementById('dashTotalAccounts').textContent = accountsData.total || 0;
                
                // è®¡ç®—æœ¬å‘¨æ–°å¢ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥åœ¨åç«¯è®¡ç®—ï¼‰
                const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                const weeklyAccounts = accountsData.accounts?.filter(a => 
                    new Date(a.createdAt).getTime() > weekAgo
                ).length || 0;
                document.getElementById('dashWeeklyAccounts').textContent = weeklyAccounts;
                
                // è·å–åŠ¨æ€ç ç»Ÿè®¡
                const codesRes = await apiFetch('/api/get-activation-codes');
                const codesData = await codesRes.json();
                const availableCodes = codesData.codes?.filter(c => !c.used && !c.expired).length || 0;
                const usedCodes = codesData.codes?.filter(c => c.used).length || 0;
                document.getElementById('dashAvailableCodes').textContent = availableCodes;
                document.getElementById('dashUsedCodes').textContent = usedCodes;
                
                // è·å–é‚®ç®±ç»Ÿè®¡
                const emailsRes = await apiFetch('/api/emails');
                const emailsData = await emailsRes.json();
                document.getElementById('dashTotalEmails').textContent = emailsData.total || 0;
                
                // è·å–IPç»Ÿè®¡
                const ipsRes = await apiFetch('/api/get-ip-records');
                const ipsData = await ipsRes.json();
                const todayIPs = new Set(ipsData.ipRecords?.filter(r => {
                    const today = new Date().toDateString();
                    return new Date(r.lastUsed).toDateString() === today;
                }).map(r => r.ip)).size || 0;
                document.getElementById('dashActiveIPs').textContent = todayIPs;
            } catch (error) {
                console.error('æ›´æ–°Dashboardå¤±è´¥:', error);
            }
        }
        
        // ç”Ÿæˆéšæœºç”¨æˆ·å
        function generateRandomUsername() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let username = '';
            for (let i = 0; i < 8; i++) {
                username += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('emailUsername').value = username;
        }
        
        // ç”Ÿæˆéšæœºå¯†ç 
        function generateRandomPassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('manualPassword').value = password;
        }
        
        // æ‰‹åŠ¨æ·»åŠ è´¦å·
        async function addAccountManually() {
            const username = document.getElementById('emailUsername').value.trim();
            let password = document.getElementById('manualPassword').value.trim();
            const service = 'Windsurf';
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åæˆ–ç‚¹å‡»"ğŸ² éšæœº"ç”Ÿæˆ');
                return;
            }
            
            // ç»„åˆå®Œæ•´é‚®ç®±
            const email = username + '@nimail.cn';
            
            // å¦‚æœå¯†ç ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
            if (!password) {
                const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%';
                password = '';
                for (let i = 0; i < 12; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            
            try {
                const response = await apiFetch('/api/save-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, service })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… è´¦å·æ·»åŠ æˆåŠŸï¼\n\né‚®ç®±ï¼š' + email + '\nå¯†ç ï¼š' + password);
                    document.getElementById('emailUsername').value = '';
                    document.getElementById('manualPassword').value = '';
                    await refreshAccounts();
                } else {
                    alert('âŒ æ·»åŠ å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                console.error('æ·»åŠ è´¦å·å¤±è´¥:', error);
                alert('âŒ æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åŠ è½½è´¦å·
        async function refreshAccounts() {
            try {
                const response = await apiFetch('/api/accounts');
                const data = await response.json();
                
                if (data.success) {
                    accounts = data.accounts;
                    renderAccounts();
                    updateStats();
                }
            } catch (error) {
                console.error('åŠ è½½è´¦å·å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“è´¦å·åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
        function renderAccounts() {
            const container = document.getElementById('accountsList');
            
            // ä½¿ç”¨è¿‡æ»¤åçš„æ•°æ®ï¼ˆåªåœ¨æœ‰æœç´¢è¯æ—¶ä½¿ç”¨è¿‡æ»¤æ•°æ®ï¼‰
            const hasSearch = document.getElementById('accountSearch')?.value?.trim();
            const dataToShow = hasSearch ? filteredAccounts : accounts;
            
            if (dataToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-title">æ²¡æœ‰æ‰¾åˆ°è´¦å·</div>
                        <p>ä½¿ç”¨æ‰©å±•æ³¨å†Œè´¦å·åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }
            
            // åˆ†é¡µè®¡ç®—
            const start = (currentAccountPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageAccounts = dataToShow.slice(start, end);
            const totalPages = Math.ceil(dataToShow.length / ITEMS_PER_PAGE);
            
            container.innerHTML = `
                <!-- å·¥å…·æ  -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <input type="checkbox" id="selectAllAccounts" onchange="toggleSelectAllAccounts()" style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="selectAllAccounts" style="cursor: pointer;">å…¨é€‰å½“å‰é¡µ</label>
                    <button class="btn btn-danger" onclick="batchDeleteAccounts()" id="batchDelAccountsBtn" disabled style="padding: 8px 16px;">
                        ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­ (<span id="selectedAccountCount">0</span>)
                    </button>
                    <input type="text" id="accountSearch" placeholder="ğŸ” æœç´¢é‚®ç®±æˆ–å¯†ç ..." 
                        style="flex: 1; max-width: 300px; padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 8px;" 
                        onkeyup="searchAccounts()">
                    <button class="btn btn-primary" onclick="exportAccounts()" style="padding: 8px 16px;">ğŸ“¥ å¯¼å‡ºCSV</button>
                </div>
                
                <!-- è´¦å·åˆ—è¡¨ -->
                ${pageAccounts.map(account => {
                    const email = (account.email || '').replace(/'/g, "\\'");
                    const checked = selectedAccounts.has(account.email) ? 'checked' : '';
                    return `
                        <div class="account-card" style="display: flex; gap: 16px; align-items: flex-start;">
                            <input type="checkbox" class="account-checkbox" value="${email}" ${checked} 
                                onchange="toggleAccountSelection('${email}')" 
                                style="width: 18px; height: 18px; cursor: pointer; margin-top: 12px;">
                            <div style="flex: 1;">
                                <div class="account-email">
                                    ğŸ“§ ${account.email}
                                </div>
                                <div class="account-password">
                                    ğŸ”’ ${account.password}
                                </div>
                                <div class="account-meta">
                                    <span class="account-time">
                                        ğŸ“… ${new Date(account.createdAt).toLocaleString('zh-CN')}
                                    </span>
                                    <div class="account-actions">
                                        <button class="btn btn-copy" onclick="copyText('${email}', 'é‚®ç®±')">å¤åˆ¶é‚®ç®±</button>
                                        <button class="btn btn-copy" onclick="copyText('${account.password}', 'å¯†ç ')">å¤åˆ¶å¯†ç </button>
                                        <button class="btn btn-primary" onclick="viewInbox('${email}')">ğŸ“¬ æŸ¥çœ‹æ”¶ä»¶ç®±</button>
                                        <button class="btn btn-danger" onclick="deleteAccount('${email}')">åˆ é™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
                
                <!-- åˆ†é¡µæ§ä»¶ -->
                ${totalPages > 1 ? `
                    <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 20px;">
                        <button onclick="changeAccountPage(1)" ${currentAccountPage === 1 ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">é¦–é¡µ</button>
                        <button onclick="changeAccountPage(${currentAccountPage - 1})" ${currentAccountPage === 1 ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">ä¸Šä¸€é¡µ</button>
                        <span style="padding: 8px 16px; background: #f3f4f6; border-radius: 8px; font-weight: 600;">
                            ç¬¬ ${currentAccountPage} / ${totalPages} é¡µ (å…± ${dataToShow.length} æ¡)
                        </span>
                        <button onclick="changeAccountPage(${currentAccountPage + 1})" ${currentAccountPage === totalPages ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">ä¸‹ä¸€é¡µ</button>
                        <button onclick="changeAccountPage(${totalPages})" ${currentAccountPage === totalPages ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">æœ«é¡µ</button>
                    </div>
                ` : ''}
            `;
            
            updateSelectedAccountsDisplay();
        }
        
        // åŠ è½½é‚®ç®±åˆ—è¡¨
        let emails = [];
        
        async function refreshEmails() {
            try {
                console.log('ğŸ“¥ [é‚®ç®±åˆ—è¡¨] å¼€å§‹åŠ è½½é‚®ç®±åˆ—è¡¨...');
                const response = await apiFetch('/api/emails');
                console.log('ğŸ“¡ [é‚®ç®±åˆ—è¡¨] å“åº”çŠ¶æ€:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¦ [é‚®ç®±åˆ—è¡¨] å“åº”æ•°æ®:', data);
                
                if (data.success) {
                    emails = data.emails || [];
                    console.log('âœ… [é‚®ç®±åˆ—è¡¨] åŠ è½½æˆåŠŸï¼Œå…±', emails.length, 'ä¸ªé‚®ç®±:', emails);
                    await renderEmails();
                } else {
                    console.error('âŒ [é‚®ç®±åˆ—è¡¨] åŠ è½½å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('âŒ [é‚®ç®±åˆ—è¡¨] è¯·æ±‚å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“é‚®ç®±åˆ—è¡¨ - æ”¶ä»¶ç®±é£æ ¼
        async function renderEmails() {
            console.log('ğŸ¨ [é‚®ç®±åˆ—è¡¨] å¼€å§‹æ¸²æŸ“ï¼Œé‚®ç®±æ•°é‡:', emails.length);
            const container = document.getElementById('emailsList');
            
            if (!container) {
                console.error('âŒ [é‚®ç®±åˆ—è¡¨] æ‰¾ä¸åˆ°å®¹å™¨ #emailsList');
                return;
            }
            
            if (emails.length === 0) {
                console.log('â„¹ï¸ [é‚®ç®±åˆ—è¡¨] æ²¡æœ‰é‚®ç®±ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-title">è¿˜æ²¡æœ‰ä¸´æ—¶é‚®ç®±</div>
                        <p>ä½¿ç”¨æ‰©å±•ç”Ÿæˆé‚®ç®±åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ“¬ [é‚®ç®±åˆ—è¡¨] å‡†å¤‡ä¸º', emails.length, 'ä¸ªé‚®ç®±åŠ è½½æ¶ˆæ¯...');
            
            // ä¸ºæ¯ä¸ªé‚®ç®±åŠ è½½æ¶ˆæ¯
            const emailsWithMessages = await Promise.all(emails.map(async (emailObj) => {
                try {
                    console.log('ğŸ“§ [é‚®ç®±åˆ—è¡¨] åŠ è½½é‚®ç®±æ¶ˆæ¯:', emailObj.email);
                    const response = await fetch(`/api/get-messages/${emailObj.email}`);
                    const data = await response.json();
                    return {
                        email: emailObj.email,
                        service: emailObj.service,
                        createdAt: emailObj.createdAt,
                        messages: data.success ? (data.messages || []) : [],
                        messageCount: data.success ? (data.messages || []).length : 0
                    };
                } catch (error) {
                    console.error('âŒ [é‚®ç®±åˆ—è¡¨] åŠ è½½æ¶ˆæ¯å¤±è´¥:', emailObj.email, error);
                    return { 
                        email: emailObj.email, 
                        service: emailObj.service,
                        createdAt: emailObj.createdAt,
                        messages: [], 
                        messageCount: 0 
                    };
                }
            }));
            
            // æ”¶ä»¶ç®±é£æ ¼
            container.innerHTML = emailsWithMessages.map(item => `
                <div style="
                    background: white;
                    border: 1px solid var(--border);
                    border-radius: 12px;
                    padding: 0;
                    margin-bottom: 20px;
                    overflow: hidden;
                ">
                    <!-- é‚®ç®±æ ‡é¢˜æ  -->
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 16px 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">ğŸ“¬</span>
                            <div>
                                <div style="color: white; font-weight: 600; font-size: 15px;">
                                    ${item.email}
                                </div>
                                <div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 2px;">
                                    å…± ${item.messageCount} å°é‚®ä»¶
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="padding: 8px 16px; font-size: 13px;" onclick="deleteEmail('${item.email}')">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                    
                    <!-- é‚®ä»¶åˆ—è¡¨ -->
                    <div style="padding: 0;">
                        ${item.messages.length > 0 ? item.messages.map((msg, msgIndex) => {
                            // æå–éªŒè¯ç 
                            const body = msg.body || msg.html || msg.text || '';
                            const codeMatch = body.match(/\b\d{4,8}\b/);
                            const verificationCode = codeMatch ? codeMatch[0] : null;
                            
                            return `
                                <div style="
                                    padding: 20px;
                                    border-bottom: 1px solid var(--border);
                                    ${msgIndex === item.messages.length - 1 ? 'border-bottom: none;' : ''}
                                    transition: background 0.2s;
                                " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 15px; font-weight: 600; color: var(--text-dark); margin-bottom: 6px;">
                                                ğŸ“¨ ${msg.subject || 'æ— ä¸»é¢˜'}
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-light);">
                                                æ¥è‡ª: ${msg.from || 'æœªçŸ¥'}
                                            </div>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-light); white-space: nowrap; margin-left: 16px;">
                                            ${new Date(msg.date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    </div>
                                    
                                    ${verificationCode ? `
                                        <div style="
                                            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                                            border: 2px solid #fbbf24;
                                            border-radius: 10px;
                                            padding: 12px 16px;
                                            margin-top: 12px;
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                        ">
                                            <div>
                                                <div style="font-size: 12px; color: #92400e; margin-bottom: 4px; font-weight: 600;">
                                                    éªŒè¯ç 
                                                </div>
                                                <div style="font-size: 24px; font-weight: 700; color: #92400e; font-family: 'Courier New', monospace; letter-spacing: 4px;">
                                                    ${verificationCode}
                                                </div>
                                            </div>
                                            <button class="btn btn-copy" onclick="copyText('${verificationCode}', 'éªŒè¯ç ')" style="white-space: nowrap;">
                                                å¤åˆ¶
                                            </button>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="margin-top: 12px;">
                                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="showFullMessage('${item.email}', '${msg.id}')">
                                            ğŸ“„ æŸ¥çœ‹å®Œæ•´é‚®ä»¶
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                                <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
                                <div style="font-size: 14px;">æ”¶ä»¶ç®±ä¸ºç©º</div>
                                <div style="font-size: 12px; margin-top: 8px;">è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•é‚®ä»¶</div>
                            </div>
                        `}
                    </div>
                </div>
            `).join('');
        }
        
        // æŸ¥çœ‹å®Œæ•´é‚®ä»¶
        async function showFullMessage(email, messageId) {
            try {
                const response = await fetch(`/api/get-message/${email}/${messageId}`);
                const data = await response.json();
                
                if (data.success && data.message) {
                    const msg = data.message;
                    const body = msg.body || msg.html || msg.text || 'æ— å†…å®¹';
                    
                    // åˆ›å»ºæ¨¡æ€çª—å£
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: white;
                            border-radius: 16px;
                            max-width: 600px;
                            width: 100%;
                            max-height: 80vh;
                            overflow: auto;
                            padding: 0;
                        ">
                            <div style="
                                padding: 20px;
                                border-bottom: 1px solid var(--border);
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                            ">
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                                    ${msg.subject || 'æ— ä¸»é¢˜'}
                                </div>
                                <div style="font-size: 13px; opacity: 0.9;">
                                    æ¥è‡ª: ${msg.from || 'æœªçŸ¥'}
                                </div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                                    ${new Date(msg.date).toLocaleString('zh-CN')}
                                </div>
                            </div>
                            <div style="padding: 20px; max-height: 400px; overflow: auto;">
                                <div style="font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
                                    ${body.substring(0, 2000)}${body.length > 2000 ? '...' : ''}
                                </div>
                            </div>
                            <div style="padding: 20px; border-top: 1px solid var(--border); text-align: right;">
                                <button class="btn btn-primary" onclick="this.closest('div').parentElement.parentElement.remove()">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    modal.onclick = (e) => {
                        if (e.target === modal) modal.remove();
                    };
                }
            } catch (error) {
                alert('âŒ åŠ è½½é‚®ä»¶å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºé‚®ä»¶è¯¦æƒ…
        async function showMessageDetail(email, messageId) {
            try {
                const response = await fetch(`/api/get-message/${email}/${messageId}`);
                const data = await response.json();
                
                if (data.success && data.message) {
                    const msg = data.message;
                    const body = msg.body || msg.html || msg.text || 'æ— å†…å®¹';
                    
                    // æå–éªŒè¯ç 
                    const codeMatch = body.match(/\b\d{4,8}\b/);
                    const verificationCode = codeMatch ? codeMatch[0] : 'æœªæ‰¾åˆ°';
                    
                    alert(`ğŸ“¬ é‚®ä»¶è¯¦æƒ…\\n\\nä¸»é¢˜: ${msg.subject || 'æ— ä¸»é¢˜'}\\næ¥è‡ª: ${msg.from || 'æœªçŸ¥'}\\næ—¶é—´: ${new Date(msg.date).toLocaleString('zh-CN')}\\n\\néªŒè¯ç : ${verificationCode}\\n\\nå†…å®¹é¢„è§ˆ:\\n${body.substring(0, 200)}...`);
                }
            } catch (error) {
                alert('âŒ åŠ è½½é‚®ä»¶å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤é‚®ç®±
        async function deleteEmail(email) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é‚®ç®± ${email} å—ï¼Ÿ`)) return;
            
            try {
                const response = await apiFetch(`/api/delete-email/${encodeURIComponent(email)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    refreshEmails();
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // ç”ŸæˆåŠ¨æ€ç 
        async function generateCodes() {
            const count = parseInt(document.getElementById('codeCount').value) || 10;
            const length = parseInt(document.getElementById('codeLength').value) || 16;
            const expireDays = parseInt(document.getElementById('codeExpireDays').value) || 30;
            const maxUses = parseInt(document.getElementById('codeMaxUses').value) || 1;
            
            const newCodes = [];
            const now = new Date();
            const expireDate = new Date(now.getTime() + expireDays * 24 * 60 * 60 * 1000);
            
            for (let i = 0; i < count; i++) {
                const code = generateRandomCode(length);
                newCodes.push({
                    code: code,
                    createdAt: now.toISOString(),
                    expiresAt: expireDate.toISOString(),
                    maxUses: maxUses, // 0è¡¨ç¤ºæ— é™æ¬¡
                    usedCount: 0,
                    used: false, // å…¼å®¹æ—§ç‰ˆæœ¬
                    usedBy: [], // ä½¿ç”¨è€…IPåˆ—è¡¨
                    usedAt: null // æœ€åä½¿ç”¨æ—¶é—´
                });
            }
            
            activationCodes.push(...newCodes);
            
            // ä¿å­˜åˆ°æœåŠ¡å™¨
            await saveActivationCodesToServer();
            
            renderCodes();
            updateStats();
            
            alert(`âœ… æˆåŠŸç”Ÿæˆ ${count} ä¸ªåŠ¨æ€ç ï¼\næœ‰æ•ˆæœŸ: ${expireDays}å¤©\nå¯ä½¿ç”¨: ${maxUses === 0 ? 'æ— é™æ¬¡' : maxUses + 'æ¬¡'}`);
        }
        
        // ç”Ÿæˆéšæœºç 
        function generateRandomCode(length) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < length; i++) {
                if (i > 0 && i % 4 === 0) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // æ¸²æŸ“åŠ¨æ€ç åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
        function renderCodes() {
            const container = document.getElementById('codesList');
            const now = new Date();
            
            console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“åŠ¨æ€ç ...');
            console.log('ğŸ“Š activationCodesæ•°é‡:', activationCodes.length);
            console.log('ğŸ“Š activationCodesç±»å‹:', typeof activationCodes, Array.isArray(activationCodes));
            
            // ä½¿ç”¨è¿‡æ»¤åçš„æ•°æ®ï¼ˆåªåœ¨æœ‰æœç´¢æˆ–ç­›é€‰æ—¶ä½¿ç”¨è¿‡æ»¤æ•°æ®ï¼‰
            const searchInput = document.getElementById('codeSearch');
            const filterSelect = document.getElementById('codeStatusFilter');
            const hasSearch = searchInput && searchInput.value && searchInput.value.trim();
            const hasFilter = filterSelect && filterSelect.value !== 'all';
            
            console.log('ğŸ“Š hasSearch:', hasSearch, 'hasFilter:', hasFilter);
            console.log('ğŸ“Š filteredCodesæ•°é‡:', filteredCodes.length);
            
            const dataToShow = (hasSearch || hasFilter) ? filteredCodes : activationCodes;
            
            console.log('ğŸ“Š dataToShowæ•°é‡:', dataToShow.length);
            console.log('ğŸ“Š å‰3ä¸ªæ•°æ®:', dataToShow.slice(0, 3));
            
            // ç»Ÿè®¡å¯ç”¨ç ï¼ˆæœªè¿‡æœŸä¸”æœªç”¨å®Œï¼‰
            const availableCount = dataToShow.filter(c => {
                const isExpired = c.expiresAt && new Date(c.expiresAt) < now;
                const isUsedUp = c.maxUses > 0 && c.usedCount >= c.maxUses;
                return !isExpired && !isUsedUp;
            }).length;
            
            document.getElementById('availableCodesCount').textContent = 
                `å¯ç”¨: ${availableCount} / ${dataToShow.length}`;
            
            if (dataToShow.length === 0) {
                console.log('âŒ dataToShowä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”‘</div>
                        <div class="empty-state-title">æ²¡æœ‰æ‰¾åˆ°åŠ¨æ€ç </div>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”ŸæˆåŠ¨æ€ç </p>
                        <p style="color: #999; font-size: 12px;">è°ƒè¯•: activationCodes=${activationCodes.length}, filteredCodes=${filteredCodes.length}</p>
                    </div>
                `;
                return;
            }
            
            console.log('âœ… å¼€å§‹æ¸²æŸ“', dataToShow.length, 'ä¸ªåŠ¨æ€ç ');
            
            // åˆ†é¡µè®¡ç®—
            const start = (currentCodePage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageCodes = dataToShow.slice(start, end);
            const totalPages = Math.ceil(dataToShow.length / ITEMS_PER_PAGE);
            
            container.innerHTML = `
                <!-- å·¥å…·æ  -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <input type="checkbox" id="selectAllCodes" onchange="toggleSelectAllCodes()" style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="selectAllCodes" style="cursor: pointer;">å…¨é€‰å½“å‰é¡µ</label>
                    <button class="btn btn-danger" onclick="batchDeleteCodes()" id="batchDelCodesBtn" disabled style="padding: 8px 16px;">
                        ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­ (<span id="selectedCodeCount">0</span>)
                    </button>
                    <input type="text" id="codeSearch" placeholder="ğŸ” æœç´¢åŠ¨æ€ç ..." 
                        style="flex: 1; max-width: 300px; padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 8px;" 
                        onkeyup="searchCodes()">
                    <select id="codeStatusFilter" onchange="filterCodesByStatus()" 
                        style="padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="available">å¯ç”¨</option>
                        <option value="used">å·²ç”¨å®Œ</option>
                        <option value="expired">å·²è¿‡æœŸ</option>
                    </select>
                </div>
                
                <!-- åŠ¨æ€ç åˆ—è¡¨ -->
                ${pageCodes.map(code => {
                    // å…¼å®¹æ—§æ•°æ®
                    if (!code.expiresAt) code.expiresAt = null;
                    if (code.maxUses === undefined) code.maxUses = 1;
                    if (code.usedCount === undefined) code.usedCount = code.used ? 1 : 0;
                    if (!Array.isArray(code.usedBy)) code.usedBy = code.usedBy ? [code.usedBy] : [];
                    
                    const isExpired = code.expiresAt && new Date(code.expiresAt) < now;
                    const isUsedUp = code.maxUses > 0 && code.usedCount >= code.maxUses;
                    const isAvailable = !isExpired && !isUsedUp;
                    const checked = selectedCodes.has(code.code) ? 'checked' : '';
                    
                    let statusText = 'å¯ç”¨', statusColor = '#10b981', statusBg = '#d1fae5', statusTextColor = '#065f46';
                    if (isExpired) {
                        statusText = 'å·²è¿‡æœŸ';
                        statusColor = '#9ca3af';
                        statusBg = '#f3f4f6';
                        statusTextColor = '#4b5563';
                    } else if (isUsedUp) {
                        statusText = 'å·²ç”¨å®Œ';
                        statusColor = '#f59e0b';
                        statusBg = '#fef3c7';
                        statusTextColor = '#92400e';
                    } else if (code.usedCount > 0) {
                        statusText = 'ä½¿ç”¨ä¸­';
                        statusColor = '#3b82f6';
                        statusBg = '#dbeafe';
                        statusTextColor = '#1e40af';
                    }
                    
                    let daysLeftText = 'æ°¸ä¹…æœ‰æ•ˆ';
                    if (code.expiresAt) {
                        const daysLeft = Math.ceil((new Date(code.expiresAt) - now) / (1000 * 60 * 60 * 24));
                        daysLeftText = daysLeft > 0 ? daysLeft + 'å¤©å' : 'å·²è¿‡æœŸ';
                    }
                    
                    return `
                        <div class="code-card" style="border-left: 4px solid ${statusColor}; display: flex; gap: 16px; align-items: flex-start;">
                            <input type="checkbox" class="code-checkbox" value="${code.code}" ${checked} 
                                onchange="toggleCodeSelection('${code.code}')" 
                                style="width: 18px; height: 18px; cursor: pointer; margin-top: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div class="code-value" style="flex: 1;">${code.code}</div>
                                    <span class="code-status" style="background: ${statusBg}; color: ${statusTextColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                        ${statusText}
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: var(--text-light); margin-bottom: 12px;">
                                    <div>ğŸ“… æœ‰æ•ˆæœŸ: ${daysLeftText}</div>
                                    <div>ğŸ”¢ ä½¿ç”¨æ¬¡æ•°: ${code.usedCount}/${code.maxUses === 0 ? 'âˆ' : code.maxUses}</div>
                                    <div>ğŸ“† åˆ›å»º: ${new Date(code.createdAt).toLocaleDateString('zh-CN')}</div>
                                    ${code.usedAt ? `<div>â° æœ€åä½¿ç”¨: ${new Date(code.usedAt).toLocaleString('zh-CN', {month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}</div>` : '<div></div>'}
                                </div>
                                ${code.usedBy && code.usedBy.length > 0 ? `
                                    <div style="font-size: 11px; color: var(--text-light); margin-bottom: 8px;">
                                        ğŸ‘¥ ä½¿ç”¨è€…: ${code.usedBy.slice(-3).join(', ')}${code.usedBy.length > 3 ? ` +${code.usedBy.length - 3}` : ''}
                                    </div>
                                ` : ''}
                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    ${isAvailable ? `
                                        <button class="btn btn-copy btn-sm" onclick="copyText('${code.code}', 'åŠ¨æ€ç ')">ğŸ“‹ å¤åˆ¶</button>
                                    ` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="deleteCode('${code.code}')">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
                
                <!-- åˆ†é¡µæ§ä»¶ -->
                ${totalPages > 1 ? `
                    <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 20px;">
                        <button onclick="changeCodePage(1)" ${currentCodePage === 1 ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">é¦–é¡µ</button>
                        <button onclick="changeCodePage(${currentCodePage - 1})" ${currentCodePage === 1 ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">ä¸Šä¸€é¡µ</button>
                        <span style="padding: 8px 16px; background: #f3f4f6; border-radius: 8px; font-weight: 600;">
                            ç¬¬ ${currentCodePage} / ${totalPages} é¡µ (å…± ${dataToShow.length} æ¡)
                        </span>
                        <button onclick="changeCodePage(${currentCodePage + 1})" ${currentCodePage === totalPages ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">ä¸‹ä¸€é¡µ</button>
                        <button onclick="changeCodePage(${totalPages})" ${currentCodePage === totalPages ? 'disabled' : ''} 
                            class="btn" style="padding: 8px 16px;">æœ«é¡µ</button>
                    </div>
                ` : ''}
            `;
            
            updateSelectedCodesDisplay();
        }
        
        // åˆ é™¤å•ä¸ªåŠ¨æ€ç 
        async function deleteCode(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åŠ¨æ€ç  ${code} å—ï¼Ÿ`)) return;
            
            selectedCodes.delete(code);
            activationCodes = activationCodes.filter(c => c.code !== code);
            await saveActivationCodesToServer();
            renderCodes();
            updateStats();
        }
        
        // åŠ¨æ€ç ç®¡ç†è¾…åŠ©å‡½æ•°
        function changeCodePage(page) {
            currentCodePage = page;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderCodes();
        }
        
        function searchCodes() {
            const keyword = document.getElementById('codeSearch').value.toLowerCase();
            const statusFilter = document.getElementById('codeStatusFilter').value;
            
            if (!keyword && statusFilter === 'all') {
                filteredCodes = [];
            } else {
                const now = new Date();
                filteredCodes = activationCodes.filter(code => {
                    // æœç´¢è¿‡æ»¤
                    const matchesSearch = !keyword || code.code.toLowerCase().includes(keyword);
                    
                    // çŠ¶æ€è¿‡æ»¤
                    let matchesStatus = true;
                    if (statusFilter !== 'all') {
                        const isExpired = code.expiresAt && new Date(code.expiresAt) < now;
                        const isUsedUp = code.maxUses > 0 && code.usedCount >= code.maxUses;
                        const isAvailable = !isExpired && !isUsedUp;
                        
                        if (statusFilter === 'available') matchesStatus = isAvailable;
                        else if (statusFilter === 'expired') matchesStatus = isExpired;
                        else if (statusFilter === 'used') matchesStatus = isUsedUp;
                    }
                    
                    return matchesSearch && matchesStatus;
                });
            }
            currentCodePage = 1;
            renderCodes();
        }
        
        function filterCodesByStatus() {
            searchCodes(); // å¤ç”¨æœç´¢é€»è¾‘
        }
        
        function toggleSelectAllCodes() {
            const checked = document.getElementById('selectAllCodes').checked;
            document.querySelectorAll('.code-checkbox').forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedCodes.add(cb.value);
                } else {
                    selectedCodes.delete(cb.value);
                }
            });
            updateSelectedCodesDisplay();
        }
        
        function toggleCodeSelection(code) {
            if (selectedCodes.has(code)) {
                selectedCodes.delete(code);
            } else {
                selectedCodes.add(code);
            }
            updateSelectedCodesDisplay();
        }
        
        function updateSelectedCodesDisplay() {
            const count = selectedCodes.size;
            const countElem = document.getElementById('selectedCodeCount');
            const btnElem = document.getElementById('batchDelCodesBtn');
            if (countElem) countElem.textContent = count;
            if (btnElem) btnElem.disabled = count === 0;
        }
        
        async function batchDeleteCodes() {
            if (selectedCodes.size === 0) return;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCodes.size} ä¸ªåŠ¨æ€ç å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            const deleteBtn = document.getElementById('batchDelCodesBtn');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'åˆ é™¤ä¸­...';
            }
            
            try {
                activationCodes = activationCodes.filter(c => !selectedCodes.has(c.code));
                await saveActivationCodesToServer();
                
                selectedCodes.clear();
                renderCodes();
                updateStats();
                alert('âœ… æ‰¹é‡åˆ é™¤æˆåŠŸï¼');
            } catch (error) {
                alert('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰åŠ¨æ€ç 
        async function clearAllCodes() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åŠ¨æ€ç å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await apiFetch('/api/clear-all-activation-codes', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    activationCodes = [];
                    renderCodes();
                    updateStats();
                    alert('âœ… æ‰€æœ‰åŠ¨æ€ç å·²æ¸…ç©º');
                } else {
                    alert('âŒ æ¸…ç©ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ¸…ç©ºåŠ¨æ€ç å¤±è´¥:', error);
                alert('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸…ç†è¿‡æœŸåŠ¨æ€ç 
        async function clearExpiredCodes() {
            const now = new Date();
            const beforeCount = activationCodes.length;
            
            activationCodes = activationCodes.filter(c => {
                const isExpired = c.expiresAt && new Date(c.expiresAt) < now;
                return !isExpired;
            });
            
            const deletedCount = beforeCount - activationCodes.length;
            
            if (deletedCount === 0) {
                alert('âœ… æ²¡æœ‰è¿‡æœŸçš„åŠ¨æ€ç ');
                return;
            }
            
            await saveActivationCodesToServer();
            renderCodes();
            updateStats();
            alert(`âœ… å·²æ¸…ç† ${deletedCount} ä¸ªè¿‡æœŸåŠ¨æ€ç `);
        }
        
        // åˆ·æ–°åŠ¨æ€ç 
        async function refreshCodes() {
            await loadActivationCodesFromServer();
            renderCodes();
        }
        
        // ä¿å­˜åŠ¨æ€ç åˆ°æœåŠ¡å™¨
        async function saveActivationCodesToServer() {
            try {
                const response = await apiFetch('/api/save-activation-codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ codes: activationCodes })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('âœ… åŠ¨æ€ç å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('ä¿å­˜åŠ¨æ€ç å¤±è´¥:', error);
                return false;
            }
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½åŠ¨æ€ç 
        async function loadActivationCodesFromServer() {
            try {
                const response = await apiFetch('/api/get-activation-codes');
                const data = await response.json();
                
                if (data.success) {
                    activationCodes = data.codes || [];
                    console.log('âœ… å·²åŠ è½½åŠ¨æ€ç :', activationCodes.length, 'ä¸ª');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('åŠ è½½åŠ¨æ€ç å¤±è´¥:', error);
                return false;
            }
        }
        
        // ä¸Šä¼ äºŒç»´ç 
        async function uploadQRCode(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶åœ¨1MBä»¥å†…ï¼‰
            if (file.size > 1024 * 1024) {
                alert('âŒ å›¾ç‰‡å¤ªå¤§ï¼è¯·é€‰æ‹©å°äº1MBçš„å›¾ç‰‡');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const qrCodeData = e.target.result;
                
                console.log('ğŸ“¤ ä¸Šä¼ äºŒç»´ç ï¼Œå¤§å°:', qrCodeData.length, 'å­—èŠ‚');
                
                // æ˜¾ç¤ºäºŒç»´ç 
                const img = document.createElement('img');
                img.src = qrCodeData;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.borderRadius = '8px';
                
                const container = document.getElementById('qrCodeContainer');
                container.innerHTML = '';
                container.appendChild(img);
                
                // ä¿å­˜åˆ°åç«¯
                try {
                    console.log('ğŸ’¾ å¼€å§‹ä¿å­˜äºŒç»´ç åˆ°Upstash...');
                    const response = await apiFetch('/api/save-donation-qrcode', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ qrCode: qrCodeData })
                    });
                    
                    console.log('ğŸ“¡ æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);
                    const data = await response.json();
                    console.log('ğŸ“¡ æœåŠ¡å™¨å“åº”æ•°æ®:', data);
                    
                    if (data.success) {
                        alert('âœ… äºŒç»´ç å·²ä¸Šä¼ å¹¶ä¿å­˜åˆ°æ•°æ®åº“ï¼\n\nåˆ·æ–°é¡µé¢åä¾ç„¶å¯ä»¥çœ‹åˆ°');
                        // ç«‹å³éªŒè¯
                        await verifyQRCodeSaved();
                    } else {
                        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('âŒ ä¿å­˜äºŒç»´ç å¤±è´¥:', error);
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }
        
        // éªŒè¯äºŒç»´ç æ˜¯å¦ä¿å­˜æˆåŠŸ
        async function verifyQRCodeSaved() {
            try {
                console.log('ğŸ” éªŒè¯äºŒç»´ç æ˜¯å¦ä¿å­˜...');
                const response = await apiFetch('/api/get-donation-qrcode');
                const data = await response.json();
                
                if (data.success && data.qrCode) {
                    console.log('âœ… éªŒè¯æˆåŠŸï¼šäºŒç»´ç å·²ä¿å­˜åˆ°æ•°æ®åº“');
                } else {
                    console.error('âŒ éªŒè¯å¤±è´¥ï¼šæ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°äºŒç»´ç ');
                }
            } catch (error) {
                console.error('âŒ éªŒè¯å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½äºŒç»´ç 
        async function loadQRCode() {
            try {
                console.log('ğŸ“¥ å¼€å§‹åŠ è½½äºŒç»´ç ...');
                const response = await apiFetch('/api/get-donation-qrcode');
                console.log('ğŸ“¡ åŠ è½½å“åº”çŠ¶æ€:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¡ åŠ è½½å“åº”æ•°æ®:', data.success ? 'æˆåŠŸ' : 'å¤±è´¥', data.qrCode ? `(æœ‰æ•°æ®ï¼Œ${data.qrCode.length}å­—èŠ‚)` : '(æ— æ•°æ®)');
                
                if (data.success && data.qrCode) {
                    const img = document.createElement('img');
                    img.src = data.qrCode;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.borderRadius = '8px';
                    
                    const container = document.getElementById('qrCodeContainer');
                    if (container) {
                        container.innerHTML = '';
                        container.appendChild(img);
                        console.log('âœ… äºŒç»´ç åŠ è½½å¹¶æ˜¾ç¤ºæˆåŠŸ');
                    } else {
                        console.error('âŒ æ‰¾ä¸åˆ°äºŒç»´ç å®¹å™¨å…ƒç´ ');
                    }
                } else {
                    console.log('â„¹ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰äºŒç»´ç ');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½äºŒç»´ç å¤±è´¥:', error);
            }
        }
        
        // åˆ é™¤è´¦å·
        async function deleteAccount(email) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/accounts/${encodeURIComponent(email)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    selectedAccounts.delete(email);
                    await refreshAccounts();
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è´¦å·ç®¡ç†è¾…åŠ©å‡½æ•°
        function changeAccountPage(page) {
            currentAccountPage = page;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderAccounts();
        }
        
        function searchAccounts() {
            const keyword = document.getElementById('accountSearch').value.toLowerCase();
            if (!keyword) {
                filteredAccounts = [];
            } else {
                filteredAccounts = accounts.filter(account =>
                    (account.email || '').toLowerCase().includes(keyword) ||
                    (account.password || '').toLowerCase().includes(keyword)
                );
            }
            currentAccountPage = 1;
            renderAccounts();
        }
        
        function toggleSelectAllAccounts() {
            const checked = document.getElementById('selectAllAccounts').checked;
            document.querySelectorAll('.account-checkbox').forEach(cb => {
                cb.checked = checked;
                const email = cb.value.replace(/\\'/g, "'");
                if (checked) {
                    selectedAccounts.add(email);
                } else {
                    selectedAccounts.delete(email);
                }
            });
            updateSelectedAccountsDisplay();
        }
        
        function toggleAccountSelection(email) {
            const actualEmail = email.replace(/\\'/g, "'");
            if (selectedAccounts.has(actualEmail)) {
                selectedAccounts.delete(actualEmail);
            } else {
                selectedAccounts.add(actualEmail);
            }
            updateSelectedAccountsDisplay();
        }
        
        function updateSelectedAccountsDisplay() {
            const count = selectedAccounts.size;
            const countElem = document.getElementById('selectedAccountCount');
            const btnElem = document.getElementById('batchDelAccountsBtn');
            if (countElem) countElem.textContent = count;
            if (btnElem) btnElem.disabled = count === 0;
        }
        
        async function batchDeleteAccounts() {
            if (selectedAccounts.size === 0) return;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedAccounts.size} ä¸ªè´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            const deleteBtn = document.getElementById('batchDelAccountsBtn');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'åˆ é™¤ä¸­...';
            }
            
            try {
                const promises = Array.from(selectedAccounts).map(email =>
                    fetch(`/api/accounts/${encodeURIComponent(email)}`, { method: 'DELETE' })
                );
                await Promise.all(promises);
                
                selectedAccounts.clear();
                await refreshAccounts();
                alert('âœ… æ‰¹é‡åˆ é™¤æˆåŠŸï¼');
            } catch (error) {
                alert('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function exportAccounts() {
            if (accounts.length === 0) {
                alert('âš ï¸ æ²¡æœ‰è´¦å·å¯ä»¥å¯¼å‡º');
                return;
            }
            
            const csv = 'é‚®ç®±,å¯†ç ,çŠ¶æ€,åˆ›å»ºæ—¶é—´\\n' +
                accounts.map(a => `${a.email},${a.password},${a.status || 'active'},${new Date(a.createdAt).toLocaleString('zh-CN')}`).join('\\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `windsurf_accounts_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… å¯¼å‡ºæˆåŠŸï¼');
        }
        
        // å¤åˆ¶æ–‡æœ¬
        function copyText(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`âœ… ${label}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼`);
            });
        }
        
        // IPç®¡ç†
        let ipRecords = {};
        let whitelist = [];
        let blacklist = [];
        
        // åŠ è½½é»‘ç™½åå•
        async function loadIPLists() {
            try {
                const response = await apiFetch('/api/get-ip-lists');
                const data = await response.json();
                
                if (data.success) {
                    whitelist = data.whitelist || [];
                    blacklist = data.blacklist || [];
                    renderIPLists();
                }
            } catch (error) {
                console.error('åŠ è½½é»‘ç™½åå•å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“é»‘ç™½åå•
        function renderIPLists() {
            // æ¸²æŸ“ç™½åå•
            const whitelistContainer = document.getElementById('whitelistIPs');
            document.getElementById('whitelistCount').textContent = whitelist.length + 'ä¸ª';
            
            if (whitelist.length === 0) {
                whitelistContainer.innerHTML = '<div style="text-align: center; color: var(--text-light); font-size: 13px; padding: 16px;">æš‚æ— ç™½åå•IP</div>';
            } else {
                whitelistContainer.innerHTML = whitelist.map(ip => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 8px; margin-bottom: 6px;">
                        <span style="font-family: monospace; font-size: 13px;">${ip}</span>
                        <button class="btn btn-danger btn-sm" onclick="removeFromWhitelist('${ip}')" style="padding: 4px 8px; font-size: 11px;">ç§»é™¤</button>
                    </div>
                `).join('');
            }
            
            // æ¸²æŸ“é»‘åå•
            const blacklistContainer = document.getElementById('blacklistIPs');
            document.getElementById('blacklistCount').textContent = blacklist.length + 'ä¸ª';
            
            if (blacklist.length === 0) {
                blacklistContainer.innerHTML = '<div style="text-align: center; color: var(--text-light); font-size: 13px; padding: 16px;">æš‚æ— é»‘åå•IP</div>';
            } else {
                blacklistContainer.innerHTML = blacklist.map(ip => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 8px; margin-bottom: 6px;">
                        <span style="font-family: monospace; font-size: 13px;">${ip}</span>
                        <button class="btn btn-success btn-sm" onclick="removeFromBlacklist('${ip}')" style="padding: 4px 8px; font-size: 11px;">ç§»é™¤</button>
                    </div>
                `).join('');
            }
        }
        
        // æ·»åŠ åˆ°ç™½åå•
        async function addToWhitelist() {
            const input = document.getElementById('whitelistIP');
            const ip = input.value.trim();
            
            if (!ip) {
                alert('âŒ è¯·è¾“å…¥IPåœ°å€');
                return;
            }
            
            // ç®€å•çš„IPæ ¼å¼éªŒè¯
            if (!/^(\d{1,3}\.){3}\d{1,3}$/.test(ip)) {
                alert('âŒ IPåœ°å€æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            
            if (whitelist.includes(ip)) {
                alert('âš ï¸ è¯¥IPå·²åœ¨ç™½åå•ä¸­');
                return;
            }
            
            if (blacklist.includes(ip)) {
                alert('âš ï¸ è¯¥IPåœ¨é»‘åå•ä¸­ï¼Œè¯·å…ˆä»é»‘åå•ç§»é™¤');
                return;
            }
            
            whitelist.push(ip);
            await saveIPLists();
            input.value = '';
            renderIPLists();
            alert('âœ… å·²æ·»åŠ åˆ°ç™½åå•');
        }
        
        // æ·»åŠ åˆ°é»‘åå•
        async function addToBlacklist() {
            const input = document.getElementById('blacklistIP');
            const ip = input.value.trim();
            
            if (!ip) {
                alert('âŒ è¯·è¾“å…¥IPåœ°å€');
                return;
            }
            
            // ç®€å•çš„IPæ ¼å¼éªŒè¯
            if (!/^(\d{1,3}\.){3}\d{1,3}$/.test(ip)) {
                alert('âŒ IPåœ°å€æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            
            if (blacklist.includes(ip)) {
                alert('âš ï¸ è¯¥IPå·²åœ¨é»‘åå•ä¸­');
                return;
            }
            
            if (whitelist.includes(ip)) {
                alert('âš ï¸ è¯¥IPåœ¨ç™½åå•ä¸­ï¼Œè¯·å…ˆä»ç™½åå•ç§»é™¤');
                return;
            }
            
            blacklist.push(ip);
            await saveIPLists();
            input.value = '';
            renderIPLists();
            alert('âœ… å·²æ·»åŠ åˆ°é»‘åå•');
        }
        
        // ä»ç™½åå•ç§»é™¤
        async function removeFromWhitelist(ip) {
            if (!confirm(`ç¡®å®šè¦ä»ç™½åå•ç§»é™¤ ${ip} å—ï¼Ÿ`)) return;
            
            whitelist = whitelist.filter(item => item !== ip);
            await saveIPLists();
            renderIPLists();
        }
        
        // ä»é»‘åå•ç§»é™¤
        async function removeFromBlacklist(ip) {
            if (!confirm(`ç¡®å®šè¦ä»é»‘åå•ç§»é™¤ ${ip} å—ï¼Ÿ`)) return;
            
            blacklist = blacklist.filter(item => item !== ip);
            await saveIPLists();
            renderIPLists();
        }
        
        // ä¿å­˜é»‘ç™½åå•åˆ°æœåŠ¡å™¨
        async function saveIPLists() {
            try {
                const response = await apiFetch('/api/save-ip-lists', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ whitelist, blacklist })
                });
                
                const data = await response.json();
                if (!data.success) {
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜é»‘ç™½åå•å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }
        
        async function refreshIPList() {
            try {
                const response = await apiFetch('/api/get-ip-records');
                const data = await response.json();
                
                if (data.success) {
                    ipRecords = data.records || {};
                    renderIPList();
                }
            } catch (error) {
                console.error('åŠ è½½IPè®°å½•å¤±è´¥:', error);
            }
        }
        
        function renderIPList() {
            const container = document.getElementById('ipList');
            const ips = Object.keys(ipRecords);
            
            if (ips.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸŒ</div>
                        <div class="empty-state-title">è¿˜æ²¡æœ‰IPè®°å½•</div>
                        <p>ç”¨æˆ·ä½¿ç”¨æ‰©å±•åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = ips.map(ip => {
                const record = ipRecords[ip];
                return `
                    <div class="account-card" style="border-left: 4px solid ${record.activated ? '#10b981' : '#f59e0b'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 700; color: var(--text-dark); margin-bottom: 4px;">
                                    ğŸŒ ${ip}
                                </div>
                                <div style="font-size: 13px; color: var(--text-light);">
                                    ä½¿ç”¨æ¬¡æ•°: ${record.count} æ¬¡
                                </div>
                            </div>
                            <span style="
                                padding: 4px 12px;
                                border-radius: 12px;
                                font-size: 12px;
                                font-weight: 600;
                                background: ${record.activated ? '#d1fae5' : '#fef3c7'};
                                color: ${record.activated ? '#065f46' : '#92400e'};
                            ">
                                ${record.activated ? 'âœ… å·²æ¿€æ´»' : 'âš ï¸ æœªæ¿€æ´»'}
                            </span>
                        </div>
                        
                        ${record.activated ? `
                            <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-size: 12px; color: var(--text-light); margin-bottom: 4px;">æ¿€æ´»ç </div>
                                <div style="font-family: 'Courier New', monospace; font-size: 13px; font-weight: 600; color: var(--primary);">
                                    ${record.activationCode}
                                </div>
                                <div style="font-size: 11px; color: var(--text-light); margin-top: 8px;">
                                    æ¿€æ´»æ—¶é—´: ${new Date(record.activatedAt).toLocaleString('zh-CN')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="account-meta">
                            <div style="font-size: 11px; color: var(--text-light);">
                                <div>é¦–æ¬¡: ${new Date(record.firstUse).toLocaleString('zh-CN')}</div>
                                <div>æœ€å: ${new Date(record.lastUse).toLocaleString('zh-CN')}</div>
                            </div>
                            <div class="account-actions">
                                ${record.activated ? `
                                    <button class="btn btn-danger" onclick="resetIPActivation('${ip}')">
                                        ğŸ”„ é‡ç½®æ¿€æ´»
                                    </button>
                                ` : `
                                    <button class="btn" style="background: var(--text-light);" disabled>
                                        æœªæ¿€æ´»
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function resetIPActivation(ip) {
            if (!confirm(`ç¡®å®šè¦é‡ç½® ${ip} çš„æ¿€æ´»çŠ¶æ€å—ï¼Ÿ\\n\\né‡ç½®åè¯¥IPéœ€è¦é‡æ–°è¾“å…¥åŠ¨æ€ç æ‰èƒ½ä½¿ç”¨ã€‚`)) {
                return;
            }
            
            try {
                const response = await apiFetch('/api/reset-ip-activation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… IPæ¿€æ´»çŠ¶æ€å·²é‡ç½®ï¼');
                    refreshIPList();
                } else {
                    alert('âŒ é‡ç½®å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ é‡ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥çœ‹æ”¶ä»¶ç®±ï¼ˆå¼¹çª—ï¼‰
        async function viewInbox(email) {
            const modal = document.getElementById('emailModal');
            const title = document.getElementById('modalEmailTitle');
            const subtitle = document.getElementById('modalEmailSubtitle');
            const list = document.getElementById('modalEmailList');
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
            title.textContent = 'ğŸ“¬ ' + email;
            subtitle.textContent = 'åŠ è½½ä¸­...';
            list.innerHTML = '<div style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`/api/get-messages/${email}`);
                const data = await response.json();
                
                if (data.success) {
                    const messages = data.messages || [];
                    subtitle.textContent = `å…± ${messages.length} å°é‚®ä»¶`;
                    
                    if (messages.length === 0) {
                        list.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                                <div style="font-size: 64px; margin-bottom: 16px;">ğŸ“­</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">æ”¶ä»¶ç®±ä¸ºç©º</div>
                                <div style="font-size: 14px;">è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•é‚®ä»¶</div>
                            </div>
                        `;
                    } else {
                        list.innerHTML = messages.map((msg, index) => {
                            const body = msg.body || msg.html || msg.text || '';
                            const codeMatch = body.match(/\b\d{4,8}\b/);
                            const verificationCode = codeMatch ? codeMatch[0] : null;
                            
                            return `
                                <div style="
                                    padding: 20px;
                                    border: 1px solid var(--border);
                                    border-radius: 12px;
                                    margin-bottom: 16px;
                                    background: white;
                                    transition: all 0.2s;
                                " onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 15px; font-weight: 600; color: var(--text-dark); margin-bottom: 6px;">
                                                ğŸ“¨ ${msg.subject || 'æ— ä¸»é¢˜'}
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-light);">
                                                æ¥è‡ª: ${msg.from || 'æœªçŸ¥'}
                                            </div>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-light); white-space: nowrap; margin-left: 16px;">
                                            ${new Date(msg.date).toLocaleString('zh-CN')}
                                        </div>
                                    </div>
                                    
                                    ${verificationCode ? `
                                        <div style="
                                            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                                            border: 2px solid #fbbf24;
                                            border-radius: 10px;
                                            padding: 12px 16px;
                                            margin: 12px 0;
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                        ">
                                            <div>
                                                <div style="font-size: 12px; color: #92400e; margin-bottom: 4px; font-weight: 600;">
                                                    éªŒè¯ç 
                                                </div>
                                                <div style="font-size: 24px; font-weight: 700; color: #92400e; font-family: 'Courier New', monospace; letter-spacing: 4px;">
                                                    ${verificationCode}
                                                </div>
                                            </div>
                                            <button class="btn btn-copy" onclick="copyText('${verificationCode}', 'éªŒè¯ç ')" style="white-space: nowrap;">
                                                å¤åˆ¶
                                            </button>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="showFullMessageInModal('${email}', '${msg.id}')">
                                            ğŸ“„ æŸ¥çœ‹å®Œæ•´å†…å®¹
                                        </button>
                                        <button class="btn btn-danger" style="padding: 8px 16px; font-size: 13px;" onclick="deleteMessage('${email}', '${msg.id}')">
                                            ğŸ—‘ï¸ åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    list.innerHTML = `<div style="text-align: center; padding: 40px; color: red;">åŠ è½½å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('åŠ è½½é‚®ä»¶å¤±è´¥:', error);
                list.innerHTML = `<div style="text-align: center; padding: 40px; color: red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // å…³é—­é‚®ä»¶å¼¹çª—
        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }
        
        // åœ¨å¼¹çª—ä¸­æŸ¥çœ‹å®Œæ•´é‚®ä»¶
        async function showFullMessageInModal(email, messageId) {
            const list = document.getElementById('modalEmailList');
            list.innerHTML = '<div style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`/api/get-message/${email}/${messageId}`);
                const data = await response.json();
                
                if (data.success && data.message) {
                    const msg = data.message;
                    const body = msg.body || msg.html || msg.text || 'æ— å†…å®¹';
                    
                    list.innerHTML = `
                        <div style="padding: 20px; background: white; border-radius: 12px;">
                            <button class="btn btn-secondary" onclick="viewInbox('${email}')" style="margin-bottom: 20px;">
                                â† è¿”å›é‚®ä»¶åˆ—è¡¨
                            </button>
                            
                            <div style="border-bottom: 2px solid var(--border); padding-bottom: 16px; margin-bottom: 16px;">
                                <h3 style="margin: 0 0 12px 0; font-size: 18px; color: var(--text-dark);">
                                    ${msg.subject || 'æ— ä¸»é¢˜'}
                                </h3>
                                <div style="font-size: 13px; color: var(--text-light); margin-bottom: 4px;">
                                    <strong>æ¥è‡ª:</strong> ${msg.from || 'æœªçŸ¥'}
                                </div>
                                <div style="font-size: 13px; color: var(--text-light);">
                                    <strong>æ—¶é—´:</strong> ${new Date(msg.date).toLocaleString('zh-CN')}
                                </div>
                            </div>
                            
                            <div style="
                                background: var(--bg-light);
                                padding: 20px;
                                border-radius: 8px;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                                font-size: 14px;
                                line-height: 1.6;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                                ${body}
                            </div>
                        </div>
                    `;
                } else {
                    list.innerHTML = `<div style="text-align: center; padding: 40px; color: red;">åŠ è½½å¤±è´¥</div>`;
                }
            } catch (error) {
                list.innerHTML = `<div style="text-align: center; padding: 40px; color: red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åˆ é™¤å•ä¸ªé‚®ä»¶
        async function deleteMessage(email, messageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å°é‚®ä»¶å—ï¼Ÿ')) {
                return;
            }
            
            // æ³¨æ„ï¼šNiMail APIå¯èƒ½ä¸æ”¯æŒåˆ é™¤å•ä¸ªé‚®ä»¶
            // è¿™é‡Œåªæ˜¯ä»ç•Œé¢ä¸Šç§»é™¤ï¼Œå®é™…å¯èƒ½éœ€è¦åç«¯APIæ”¯æŒ
            alert('âš ï¸ ä¸´æ—¶é‚®ç®±æœåŠ¡ä¸æ”¯æŒåˆ é™¤å•ä¸ªé‚®ä»¶\n\næ‚¨å¯ä»¥åˆ é™¤æ•´ä¸ªé‚®ç®±æ¥æ¸…é™¤æ‰€æœ‰é‚®ä»¶');
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('totalCodes').textContent = activationCodes.filter(c => !c.used).length;
            
            const today = new Date().toDateString();
            const todayCount = accounts.filter(a => 
                new Date(a.createdAt).toDateString() === today
            ).length;
            document.getElementById('todayAccounts').textContent = todayCount;
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–Dashboardæ•°æ®
            await updateDashboard();
            await updateStats();
            
            // åŠ è½½å…¶ä»–æ•°æ®
            refreshAccounts();
            await loadActivationCodesFromServer();
            renderCodes(); // æ¸²æŸ“åŠ¨æ€ç åˆ—è¡¨
            loadQRCode();
        });
    </script>
</body>
</html>
