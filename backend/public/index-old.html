<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ç®±ç®¡ç†åå° - å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .emails-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .pagination-info {
            color: #666;
            font-size: 14px;
        }
        
        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .page-size-selector {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-warning {
            background: #ff9800;
        }
        
        .btn-success {
            background: #4caf50;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* é‚®ç®±åˆ—è¡¨æ ·å¼ */
        .email-list {
            display: grid;
            gap: 15px;
        }
        
        .email-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
        }
        
        .email-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .email-item.selected-for-batch {
            border-color: #4caf50;
            background: #f1f8f4;
        }
        
        .email-checkbox {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .email-content {
            margin-left: 35px;
        }
        
        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .email-address {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }
        
        .email-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
            flex-wrap: wrap;
        }
        
        .badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge.success {
            background: #4caf50;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .web-link {
            display: inline-block;
            padding: 6px 12px;
            background: #4caf50;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ‰¹é‡æ“ä½œæ  */
        .batch-actions-bar {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }
        
        .batch-actions-bar.show {
            display: flex;
        }
        
        .batch-info {
            font-weight: 600;
            color: #856404;
        }
        
        .batch-buttons {
            display: flex;
            gap: 10px;
        }
        
        .messages-panel {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .message-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .verification-code {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
        }
        
        .verification-code strong {
            font-size: 24px;
            color: #ff6b6b;
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“§ Windsurf è‡ªåŠ¨æ³¨å†Œ - ç®¡ç†åå°</h1>
        
        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('emails')">ğŸ“§ é‚®ç®±åˆ—è¡¨</button>
            <button class="tab-btn" onclick="switchTab('accounts')">ğŸ” è´¦å·ç®¡ç†</button>
        </div>
        
        <!-- é‚®ç®±åˆ—è¡¨æ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="emails-tab">
        <div class="header">
            <h1>ğŸ“§ é‚®ç®±ç®¡ç†åå° - å¢å¼ºç‰ˆ</h1>
            <p>æ”¯æŒåˆ†é¡µã€æœç´¢å’Œæ‰¹é‡æ“ä½œ</p>
            
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalEmails">0</h3>
                    <p>æ€»é‚®ç®±æ•°</p>
                </div>
                <div class="stat-card">
                    <h3 id="currentPageCount">0</h3>
                    <p>å½“å‰é¡µæ•°é‡</p>
                </div>
                <div class="stat-card">
                    <h3 id="selectedCount">0</h3>
                    <p>å·²é€‰æ‹©</p>
                </div>
            </div>
        </div>
        
        <div class="emails-section">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢é‚®ç®±åœ°å€..." onkeyup="handleSearch()">
                </div>
                <div class="toolbar-actions">
                    <button onclick="refreshEmails()">ğŸ”„ åˆ·æ–°</button>
                    <button onclick="createNewEmail()">â• æ–°å»ºé‚®ç®±</button>
                    <button class="btn-warning" onclick="toggleSelectAll()">â˜‘ï¸ å…¨é€‰/å–æ¶ˆ</button>
                    <button class="btn-danger" onclick="clearAllEmails()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                </div>
            </div>
            
            <!-- æ‰¹é‡æ“ä½œæ  -->
            <div id="batchActionsBar" class="batch-actions-bar">
                <div class="batch-info">
                    å·²é€‰æ‹© <span id="batchCount">0</span> ä¸ªé‚®ç®±
                </div>
                <div class="batch-buttons">
                    <button class="btn-danger btn-small" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
                </div>
            </div>
            
            <!-- é‚®ç®±åˆ—è¡¨ -->
            <div id="emailList" class="email-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- è´¦å·ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="accounts-tab">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-title">ä¿å­˜çš„è´¦å·</div>
                    <div class="stat-value" id="accountsCount">0</div>
                </div>
            </div>
            
            <!-- æ·»åŠ è´¦å·æŒ‰é’® -->
            <button onclick="showAddAccountModal()" style="
                padding: 12px 24px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                margin-bottom: 20px;
                font-size: 14px;
                transition: transform 0.2s;
            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                â• æ‰‹åŠ¨æ·»åŠ è´¦å·
            </button>
            
            <div class="accounts-list" id="accountsList">
                <p class="loading">åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- æ·»åŠ è´¦å·å¼¹çª— -->
        <div id="addAccountModal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        ">
            <div style="
                background: white;
                padding: 30px;
                border-radius: 15px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            ">
                <h2 style="margin: 0 0 20px 0; color: #667eea;">â• æ·»åŠ è´¦å·</h2>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">é‚®ç®±åœ°å€</label>
                    <input id="newAccountEmail" type="email" placeholder="ä¾‹å¦‚: user@example.com" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        font-size: 14px;
                        box-sizing: border-box;
                    ">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">å¯†ç </label>
                    <input id="newAccountPassword" type="text" placeholder="è¾“å…¥å¯†ç " style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        font-size: 14px;
                        box-sizing: border-box;
                    ">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">æœåŠ¡åç§°</label>
                    <input id="newAccountService" type="text" value="Windsurf" placeholder="ä¾‹å¦‚: Windsurf" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        font-size: 14px;
                        box-sizing: border-box;
                    ">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveNewAccount()" style="
                        flex: 1;
                        padding: 12px;
                        background: linear-gradient(135deg, #4caf50, #45a049);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 14px;
                    ">ğŸ’¾ ä¿å­˜</button>
                    <button onclick="closeAddAccountModal()" style="
                        flex: 1;
                        padding: 12px;
                        background: #f5f5f5;
                        color: #666;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 14px;
                    ">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
        <div class="pagination" style="display: none;">
                <div class="pagination-info">
                    æ˜¾ç¤º <span id="pageStart">0</span>-<span id="pageEnd">0</span> 
                    / å…± <span id="totalCount">0</span> ä¸ªé‚®ç®±
                </div>
                <div class="pagination-controls">
                    <select id="pageSizeSelect" class="page-size-selector" onchange="changePageSize()">
                        <option value="10">10 æ¡/é¡µ</option>
                        <option value="20">20 æ¡/é¡µ</option>
                        <option value="50">50 æ¡/é¡µ</option>
                        <option value="100">100 æ¡/é¡µ</option>
                    </select>
                    <button onclick="goToPage(1)" id="firstPageBtn">é¦–é¡µ</button>
                    <button onclick="goToPage(currentPage - 1)" id="prevPageBtn">ä¸Šä¸€é¡µ</button>
                    <span>ç¬¬ <span id="currentPageNum">1</span> / <span id="totalPages">1</span> é¡µ</span>
                    <button onclick="goToPage(currentPage + 1)" id="nextPageBtn">ä¸‹ä¸€é¡µ</button>
                    <button onclick="goToPage(totalPagesCount)" id="lastPageBtn">æœ«é¡µ</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let emails = [];
        let currentPage = 1;
        let pageSize = 10;
        let totalPagesCount = 1;
        let totalCount = 0;
        let searchKeyword = '';
        let selectedEmails = new Set();
        let currentTab = 'emails';
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabContent = document.getElementById(`${tab}-tab`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tab === 'emails') {
                loadEmails();
            } else if (tab === 'accounts') {
                loadAccounts();
            }
        }
        
        // åŠ è½½è´¦å·åˆ—è¡¨
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                
                if (data.success) {
                    displayAccounts(data.accounts);
                    document.getElementById('accountsCount').textContent = data.total;
                }
            } catch (error) {
                console.error('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('accountsList').innerHTML = 
                    '<p class="loading" style="color: #f44336;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
            }
        }
        
        // æ˜¾ç¤ºè´¦å·åˆ—è¡¨
        function displayAccounts(accounts) {
            const container = document.getElementById('accountsList');
            
            if (accounts.length === 0) {
                container.innerHTML = '<p class="loading">æš‚æ— ä¿å­˜çš„è´¦å·</p>';
                return;
            }
            
            container.innerHTML = accounts.map(account => `
                <div class="email-card">
                    <div class="email-header">
                        <div class="email-address">
                            <span class="email-icon">ğŸ”</span>
                            <strong>${account.email}</strong>
                        </div>
                        <div class="email-actions">
                            <button class="btn-copy" onclick="copyText('${account.email}', 'é‚®ç®±')">
                                ğŸ“‹ å¤åˆ¶é‚®ç®±
                            </button>
                            <button class="btn-copy" onclick="copyText('${account.password}', 'å¯†ç ')">
                                ğŸ”‘ å¤åˆ¶å¯†ç 
                            </button>
                            <button class="btn-delete" onclick="deleteAccount('${account.email}')">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <div class="email-meta">
                        <span class="meta-item">
                            <span class="meta-icon">ğŸ”‘</span>
                            å¯†ç : <code>${account.password}</code>
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">ğŸ“…</span>
                            åˆ›å»º: ${formatTime(new Date(account.createdAt).getTime())}
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">ğŸŒ</span>
                            æœåŠ¡: ${account.service || 'Windsurf'}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        // åˆ é™¤è´¦å·
        async function deleteAccount(email) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦å· ${email} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${encodeURIComponent(email)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('è´¦å·å·²åˆ é™¤');
                    loadAccounts();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤è´¦å·å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å¤åˆ¶æ–‡æœ¬
        function copyText(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`${label}å·²å¤åˆ¶: ${text}`);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }
        
        // æ˜¾ç¤ºæ·»åŠ è´¦å·å¼¹çª—
        function showAddAccountModal() {
            const modal = document.getElementById('addAccountModal');
            modal.style.display = 'flex';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('newAccountEmail').value = '';
            document.getElementById('newAccountPassword').value = '';
            document.getElementById('newAccountService').value = 'Windsurf';
        }
        
        // å…³é—­æ·»åŠ è´¦å·å¼¹çª—
        function closeAddAccountModal() {
            const modal = document.getElementById('addAccountModal');
            modal.style.display = 'none';
        }
        
        // ä¿å­˜æ–°è´¦å·
        async function saveNewAccount() {
            const email = document.getElementById('newAccountEmail').value.trim();
            const password = document.getElementById('newAccountPassword').value.trim();
            const service = document.getElementById('newAccountService').value.trim() || 'Windsurf';
            
            // éªŒè¯è¾“å…¥
            if (!email) {
                alert('è¯·è¾“å…¥é‚®ç®±åœ°å€');
                return;
            }
            
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }
            
            // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            
            try {
                const response = await fetch('/api/save-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        service: service
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… è´¦å·ä¿å­˜æˆåŠŸï¼');
                    closeAddAccountModal();
                    loadAccounts(); // åˆ·æ–°è´¦å·åˆ—è¡¨
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜è´¦å·å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('addAccountModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAddAccountModal();
                    }
                });
            }
        });
        
        // é¡µé¢åŠ è½½
        window.addEventListener('load', () => {
            loadEmails();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(() => {
                if (selectedEmails.size === 0) {
                    loadEmails();
                }
            }, 30000);
        });
        
        // åŠ è½½é‚®ç®±åˆ—è¡¨
        async function loadEmails() {
            try {
                const url = `/api/emails?page=${currentPage}&pageSize=${pageSize}${searchKeyword ? '&search=' + searchKeyword : ''}`;
                console.log('è¯·æ±‚URL:', url);
                const response = await fetch(url);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);
                
                if (data.success) {
                    emails = data.emails || [];
                    
                    // å…¼å®¹æ—§ç‰ˆ APIï¼ˆæ²¡æœ‰ paginationï¼‰
                    if (data.pagination) {
                        totalCount = data.pagination.total;
                        totalPagesCount = data.pagination.totalPages;
                    } else {
                        // æ—§ç‰ˆ API ä½¿ç”¨ count
                        totalCount = data.count || emails.length;
                        totalPagesCount = 1;
                    }
                    
                    updateStats();
                    renderEmails();
                    updatePagination();
                } else {
                    console.error('API è¿”å›å¤±è´¥:', data);
                }
            } catch (error) {
                console.error('åŠ è½½é‚®ç®±å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.getElementById('emailList').innerHTML = `
                    <div class="empty-state">
                        <h3>âŒ åŠ è½½å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <button onclick="loadEmails()">é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalEmails').textContent = totalCount;
            document.getElementById('currentPageCount').textContent = emails.length;
            document.getElementById('selectedCount').textContent = selectedEmails.size;
        }
        
        // æ¸²æŸ“é‚®ç®±åˆ—è¡¨
        function renderEmails() {
            const container = document.getElementById('emailList');
            
            if (emails.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ˜Š æš‚æ— é‚®ç®±</h3>
                        <p>ç‚¹å‡»"æ–°å»ºé‚®ç®±"åˆ›å»ºç¬¬ä¸€ä¸ªä¸´æ—¶é‚®ç®±</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = emails.map(email => `
                <div class="email-item ${selectedEmails.has(email.email) ? 'selected-for-batch' : ''}" id="email-${email.email.replace(/[@.]/g, '-')}">
                    <input type="checkbox" class="email-checkbox" 
                           ${selectedEmails.has(email.email) ? 'checked' : ''}
                           onchange="toggleEmailSelection('${email.email}')">
                    <div class="email-content">
                        <div class="email-header">
                            <div class="email-address">${email.email}</div>
                            <span class="badge ${email.messageCount > 0 ? 'success' : ''}">${email.messageCount || 0} å°é‚®ä»¶</span>
                        </div>
                        <div class="email-meta">
                            <span>ğŸ“… ${formatTime(email.createdAt)}</span>
                            <span>â° ${getTimeAgo(email.createdAt)}</span>
                            <span>ğŸ”§ ${email.service || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="actions">
                            <button class="btn-small btn-success" onclick="checkMessages('${email.email}')">æ£€æŸ¥é‚®ä»¶</button>
                            <button class="btn-small" onclick="copyEmail('${email.email}')">å¤åˆ¶é‚®ç®±</button>
                            ${email.webUrl ? `<a href="${email.webUrl}" target="_blank" class="web-link">ğŸŒ ç½‘é¡µæŸ¥çœ‹</a>` : ''}
                            <button class="btn-small btn-danger" onclick="deleteEmail('${email.email}')">åˆ é™¤</button>
                        </div>
                        <div id="messages-${email.email.replace(/[@.]/g, '-')}" class="messages-panel" style="display: none;"></div>
                    </div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updatePagination() {
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalCount);
            
            document.getElementById('pageStart').textContent = totalCount > 0 ? start : 0;
            document.getElementById('pageEnd').textContent = end;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('currentPageNum').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPagesCount || 1;
            
            const firstBtn = document.getElementById('firstPageBtn');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const lastBtn = document.getElementById('lastPageBtn');
            
            if (firstBtn) firstBtn.disabled = currentPage === 1;
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPagesCount;
            if (lastBtn) lastBtn.disabled = currentPage >= totalPagesCount;
        }
        
        // è·³è½¬é¡µé¢
        function goToPage(page) {
            if (page < 1 || page > totalPagesCount) return;
            currentPage = page;
            loadEmails();
        }
        
        // æ”¹å˜æ¯é¡µæ•°é‡
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            loadEmails();
        }
        
        // æœç´¢
        function handleSearch() {
            searchKeyword = document.getElementById('searchInput').value.trim();
            currentPage = 1;
            loadEmails();
        }
        
        // åˆ‡æ¢é‚®ç®±é€‰æ‹©
        function toggleEmailSelection(email) {
            if (selectedEmails.has(email)) {
                selectedEmails.delete(email);
            } else {
                selectedEmails.add(email);
            }
            updateBatchActionsBar();
            renderEmails();
        }
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            if (selectedEmails.size === emails.length) {
                selectedEmails.clear();
            } else {
                emails.forEach(email => selectedEmails.add(email.email));
            }
            updateBatchActionsBar();
            renderEmails();
        }
        
        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            selectedEmails.clear();
            updateBatchActionsBar();
            renderEmails();
        }
        
        // æ›´æ–°æ‰¹é‡æ“ä½œæ 
        function updateBatchActionsBar() {
            const bar = document.getElementById('batchActionsBar');
            const count = document.getElementById('batchCount');
            
            if (selectedEmails.size > 0) {
                bar.classList.add('show');
                count.textContent = selectedEmails.size;
            } else {
                bar.classList.remove('show');
            }
            
            document.getElementById('selectedCount').textContent = selectedEmails.size;
        }
        
        // æ‰¹é‡åˆ é™¤
        async function batchDelete() {
            if (selectedEmails.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é‚®ç®±');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedEmails.size} ä¸ªé‚®ç®±å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-emails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails: Array.from(selectedEmails) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    selectedEmails.clear();
                    updateBatchActionsBar();
                    loadEmails();
                } else {
                    alert('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰é‚®ç®±
        async function clearAllEmails() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é‚®ç®±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            if (!confirm('âš ï¸ å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰é‚®ç®±å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-all', {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    selectedEmails.clear();
                    updateBatchActionsBar();
                    currentPage = 1;
                    loadEmails();
                } else {
                    alert('âŒ æ¸…ç©ºå¤±è´¥');
                }
            } catch (error) {
                alert('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ›å»ºæ–°é‚®ç®±
        async function createNewEmail() {
            try {
                const response = await fetch('/api/generate-email', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… æ–°é‚®ç®±åˆ›å»ºæˆåŠŸ!\n\né‚®ç®±: ${data.email}\næœåŠ¡: ${data.service}`);
                    loadEmails();
                } else {
                    alert('âŒ åˆ›å»ºå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤å•ä¸ªé‚®ç®±
        async function deleteEmail(email) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é‚®ç®± ${email} å—ï¼Ÿ`)) return;
            
            try {
                const response = await fetch(`/api/delete-email/${encodeURIComponent(email)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… åˆ é™¤æˆåŠŸ');
                    selectedEmails.delete(email);
                    updateBatchActionsBar();
                    loadEmails();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // æ£€æŸ¥é‚®ä»¶
        async function checkMessages(email) {
            const messagesPanel = document.getElementById(`messages-${email.replace(/[@.]/g, '-')}`);
            messagesPanel.style.display = 'block';
            messagesPanel.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½é‚®ä»¶ä¸­...</p></div>';
            
            try {
                const response = await fetch(`/api/get-messages/${encodeURIComponent(email)}`);
                const data = await response.json();
                
                if (data.success && data.messages.length > 0) {
                    const messageDetails = await Promise.all(
                        data.messages.map(msg => 
                            fetch(`/api/get-message/${encodeURIComponent(email)}/${msg.id}`)
                                .then(r => r.json())
                        )
                    );
                    
                    messagesPanel.innerHTML = messageDetails.map(detail => {
                        if (!detail.success) return '';
                        const msg = detail.message;
                        const code = detail.verificationCode;
                        
                        return `
                            <div class="message-item">
                                <div><strong>ğŸ“¨ ${msg.from}</strong></div>
                                <div><strong>${msg.subject}</strong></div>
                                <div style="margin-top:10px">${(msg.textBody || msg.body || '').substring(0, 200)}...</div>
                                ${code ? `
                                    <div class="verification-code">
                                        <p>ğŸ”‘ éªŒè¯ç :</p>
                                        <strong>${code}</strong>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    messagesPanel.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— é‚®ä»¶</p>';
                }
            } catch (error) {
                messagesPanel.innerHTML = '<p style="text-align: center; color: #f44336; padding: 20px;">åŠ è½½å¤±è´¥</p>';
            }
        }
        
        // å¤åˆ¶é‚®ç®±
        function copyEmail(email) {
            navigator.clipboard.writeText(email).then(() => {
                alert('âœ… é‚®ç®±å·²å¤åˆ¶: ' + email);
            });
        }
        
        // åˆ·æ–°
        function refreshEmails() {
            loadEmails();
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }
        
        // ç›¸å¯¹æ—¶é—´
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'åˆšåˆš';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} åˆ†é’Ÿå‰`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} å°æ—¶å‰`;
            return `${Math.floor(seconds / 86400)} å¤©å‰`;
        }
    </script>
</body>
</html>
